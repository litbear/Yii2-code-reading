#数据库迁移

在开发和维护一个数据库驱动的应用程序时，数据库的结构会随代码的改变而改变。例如，在开发应用程序的过程中，会增加一张新表且必须得加进来；在应用程序被部署到生产环境后，需要建立一个索引来提高查询的性能等等。 因为一个数据库结构发生改变的时候源代码也经常会需要做出改变，Yii 提供了一个`数据库迁移`功能，该功能可以记录数据库的变化， 以便使数据库和源代码一起受版本控制。  

如下的步骤向我们展示了数据库迁移工具是如何为开发团队所使用的：

1. Tim 创建了一个新的迁移对象（例如，创建一张新的表单，改变字段的定义等）。
2. Tim 将这个新的迁移对象提交到代码管理系统（例如，Git，Mercurial）。
3. Doug 从代码管理系统当中更新版本并获取到这个新的迁移对象。
4. Doug 把这个迁移对象提交到本地的开发数据库当中，这样一来，Doug 同步了 Tim 所做的修改。

如下的步骤向我们展示了如何发布一个附带数据库迁移的新版本到生产环境当中：

1. Scott 为一个包含数据库迁移的项目版本创建了一个发布标签。
2. Scott 把发布标签的源代码更新到生产环境的服务器上。
3. Scott 把所有的增量数据库迁移提交到生产环境数据库当中。

Yii 提供了一整套的迁移命令行工具，通过这些工具你可以：

- 创建新的迁移；
- 提交迁移；
- 恢复迁移；
- 重新提交迁移；
- 现实迁移历史和状态。

所有的这些工具都可以通过`yii migrate`命令来进行操作。在这一章节，我们将详细的介绍如何使用这些工具来完成各种各样的任务。你也可以通过`yii help migrate`命令来获取每一种工具的具体使用方法。

> 注意：因为`name`参数会被用来生成迁移的类名的一部分，所以该参数应当只包含字母、数字和下划线。

##创建迁移

使用如下命令来创建一个新的迁移：
```
yii migrate/create <name>
```
必填参数`name`的作用是对新的迁移做一个简要的描述。例如，如果这个迁移是用来创建一个叫做`news`的表单的，那么你可以使用`create_news_table`这个名称并运行如下命令：
```
yii migrate/create create_news_table
```
> 注意：因为`name`参数会被用来生成迁移的类名的一部分，所以该参数应当只包含字母、数字和下划线。

如上命令将会在`@app/migrations`目录下创建一个新的名为`m150101_185401_create_news_table.php`的`PHP`类文件。该文件包含如下的代码，它们用来声明一个迁移类`m150101_185401_create_news_table`，并附有代码框架：

```php
<?php

use yii\db\Schema;
use yii\db\Migration;

class m150101_185401_create_news_table extends Migration
{
    public function up()
    {
    }

    public function down()
    {
        echo "m101129_185401_create_news_table cannot be reverted.\n";
        return false;
    }
}
?>
```

每个数据库迁移都会被定义为一个继承自`yii\db\Migration`的`PHP`类。类的名称按照`m<YYMMDD_HHMMSS>_<Name>`的格式自动生成，其中：
- `<YYMMDD_HHMMSS>`指执行创建迁移命令的`UTC 时间。
- `<Name>`和你执行命令时所带的`name`参数值相同。

在迁移类当中，你应当在`up() 方法中编写改变数据库结构的代码。你可能还需要在`down()`方法中编写代码来恢复由`up()`方法所做的改变。 当你通过`migration`升级数据库时，`up()`方法将会被调用，反之，`down()`将会被调用。如下代码展示了如何通过迁移类来创建一张`news`表：
```php
use yii\db\Schema;
use yii\db\Migration;

class m150101_185401_create_news_table extends \yii\db\Migration
{
    public function up()
    {
        $this->createTable('news', [
            'id' => Schema::TYPE_PK,
            'title' => Schema::TYPE_STRING . ' NOT NULL',
            'content' => Schema::TYPE_TEXT,
        ]);
    }

    public function down()
    {
        $this->dropTable('news');
    }

}
```

> 注意：并不是所有迁移都是可恢复的。例如，如果`up()`方法删除了表中的一行数据，这将无法通过`down()`方法来恢复这条数据。有时候，你也许只是懒得去执行`down()`方法了，因为它在恢复数据库迁移方面并不是那么的通用。在这种情况下，你应当在`down()`方法中返回`false`来表明这个`migration`是无法恢复的。

`migration`的基类`yii\db\Migration`通过`yii\db\Migration::db`属性来连接了数据库。你可以通过[配合数据库工作](db-dao.md#working-with-database-schema-)章节中所描述的那些方法来操作数据库表。

当你通过`migration`创建一张表或者字段的时候，你应该使用`抽象类型`而不是`实体类型`，这样一来你的迁移对象就可以从特定的`DBMS`当中抽离出来。`yii\db\Schema`类定义了一整套可用的抽象类型常量。这些常量的格式为`TYPE_<Name>`。例如，`TYPE_PK`指代自增主键类型；`TYPE_STRING`指代字符串类型。 当迁移对象被提交到某个特定的数据库的时候，这些抽象类型将会被转换成相对应的实体类型。以`MySQL`为例，`TYPE_PK`将会变成`int(11) NOT NULL AUTO_INCREMENT PRIMARY KEY`， 而`TYPE_STRING`则变成`varchar(255)`。

在使用抽象类型的时候，你可以添加额外的约束条件。在上面的例子当中，`NOT NULL`被添加到`Schema::TYPE_STRING`当中来指定该字段不能为空。

> 提示：抽象类型和实体类型之间的映射关系是由每个具体的`QueryBuilder`类当中的`yii\db\QueryBuilder::$typeMap`属性所指定的。

从`2.0.6`的版本开始，`schema`构造器提供了更加方便的方法来定义字段，因此上面的`migration`可以被改写成：
```php
use yii\db\Schema;
use yii\db\Migration;

class m150101_185401_create_news_table extends \yii\db\Migration
{
    public function up()
    {
        $this->createTable('news', [
            'id' => Schema::primaryKey(),
            'title' => Schema::string()->notNull(),
            'content' => Schema::text(),
        ]);
    }

    public function down()
    {
        $this->dropTable('news');
    }

}
```

所有用于定义列类型的可用方法列表均可在[[yii\db\SchemaBuilderTrait]]的接口文档中找到。

##生成迁移

从2.0.7版开始，数据库迁移终端提供了一种简便方法创建数据库迁移文件。

假如迁移对象的名称包括但不限于`create_xxx`或`drop_xxx`，那么迁移文件将会在创建时包含额外的数据。【没看懂】  

###创建数据库表

> yii migrate/create create_post

得出的迁移对象代码如下：

```php
class m150811_220037_create_post extends Migration
{
    public function up()
    {
        $this->createTable('post', [
            'id' => $this->primaryKey()
        ]);
    }

    public function down()
    {
        $this->dropTable('post');
    }
}
```

通过指定`--fields`选项，创建表的字段：

> yii migrate/create create_post --fields=title:string,body:text

得出的迁移对象代码如下：

```php
class m150811_220037_create_post extends Migration
{
    public function up()
    {
        $this->createTable('post', [
            'id' => $this->primaryKey(),
            'title' => $this->string(),
            'body' => $this->text()
        ]);
    }

    public function down()
    {
        $this->dropTable('post');
    }
}
```

还可以指定更多的参数

> yii migrate/create create_post --fields=title:string(12):notNull:unique,body:text

得出的迁移对象代码如下：

```php
class m150811_220037_create_post extends Migration
{
    public function up()
    {
        $this->createTable('post', [
            'id' => $this->primaryKey(),
            'title' => $this->string(12)->notNull()->unique(),
            'body' => $this->text()
        ]);
    }

    public function down()
    {
        $this->dropTable('post');
    }
}
```

> 注意：主键被自动添加并且默认命名为id。假如你想使用其他主键明，你需要使用额外的选项指定它`--fields=name:primaryKey`。

